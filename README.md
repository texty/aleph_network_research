# Як можна працювати з даними Aleph розробнику

Якщо у вас будуть питання або пропозиції щодо співпраці пишіть на — texty.team@gmail.com


## API Aleph 
[Документації](https://redocly.github.io/redoc/?url=https://aleph.occrp.org/api/openapi.json#section/General-Overview), API Алефа детально описує які запити можна надіслати і яку інформацію отримати від Алефа. 

Для того, щоб надіслати запит потрібно додати до нього ключ API який можна знайти в налаштуваннях вашого особистого профілю в Алефі. Наприклад запит щодо загальної інформаці про датасет виглядає так.

```
https://aleph.texty.org.ua/api/2/collections/1?api_key=<your_key>
```

Також варто звернути увагу на загальну технічну [документацію](https://docs.alephdata.org/developers/intro) Алефа. У ній описано як підняти власну версію програми, а також як працює структура даних Follow the Money і інші деталі реалізації Алефа. 

## Мережеві дані



Для того, щоб всю мережеву інформацію з певного датасета в Алефі потрібно отримати всі `entity` з цього dataset. Це легко зробити за допомогою запиту до API:
 ```
https://aleph.texty.org.ua/api/2/collections/<collection_id>/_stream?api_key=<your_key>
```

Ви отримаєте дані у вигляді `.jsonl` файлу де кожен рядок відповідає одній сутності в Алефі. Для того, щоб швидко конвертувати цей файл в формати придатні для роботи з мережевою інформацією варто застосувати [ftm](https://docs.alephdata.org/developers/followthemoney/ftm#cypher-commands-for-neo4j) утиліта для командного рядка реалізована як бібліотека на мові Python. Вона дозволяє конвертувати дані з Алефа в графи, та табличні формати.

Якщо ми працюємо з графами нас цікавлять 3 можливих формати вивантаження: `.csv`, `.gexf` та команди мовою `cypher` для `neo4j`.

Найпростіше вивантажити дані у вигляді `.gexf` і почати працювати з ними за допомогою програми [Gephi](https://gephi.org/). Gephi це вільна програма для обробки та 
візуалізації графів. Її можна легко завантажити та встановити на свій комп'ютер, а після цього імпортувати файл `.gexf` та працювати з ним всередині програми. Вона 
дозволяє фільтрувати граф, робити обрахунки, візуалізувати та зберігати оброблений граф. 

Але головне обмеження Gephi у тому, що він не може працювати з надто великими мережами оскільки обрахунку стають занадто довгими і не можливо візуалізувати таку мережу. Але його можна використовувати, щоб дослідувати та візуалізувати окремі елементи мережі, що цікаві для вас.


-------

Також зручним варінтом для роботи з мережею може стати графова база даних `neo4j`. Про те як встановити цю базу читайте [тут](https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-neo4j-on-ubuntu-20-04)
), а а також читайте як працювати з [браузерним переглядачів](https://neo4j.com/docs/browser-manual/current/operations/dbms-connection/) neo4j. Після того як база встановлена і сконфігурована, ви можете відкрити переглядач за посиланням: `http://localhost:7474/browser/`.

Дані в цю ьазу можна завантажити декількома способами, напряму:

`cat collections_stream.jsonl | ftm export-cypher -e name -e iban -e entity -e address > neo4j_commands` таким чином ви згенеруєте файл з командами для `neo4j` який відтворить ваш граф всередині `neo4j`.
 
Також можна напряму залити граф всередину бази за допомогою `cypher-shell`. 

```
cat collections_stream.jsonl | ftm export-cypher -e name -e iban -e entity -e address | cypher-shell -u user -p password
```

Важливо звернути увагу на параметри `-e name -e iban -e entity -e address` для команди `ftm export-cypher`. Вона вказують Алефу які саме зв'язки включати у вашу мережу. За замовчуванням, вона буде включати лише прямі зв'язки між різними сутностями, але додаючи додаткові параметри можна створювати додаткові зв'язки на основі спільних імен, адрес, номерів банківських карток ітд...Запустіть `ftm export-cypher --help`, щоб побачити всі можливі варіанти. 

На жаль описані вище методи, можуть надто довго імпортувати дуже велику мережу. Тому альтернативою є `bulk data loading` в `neo4j`. 
 
```
cat collections_stream.jsonl | ftm export-neo4j-bulk -o folder_name -e iban -e entity -e name
```

ftm export-neo4j-bulk — експортує інформацію про сутності у вигляді `.csv` файлів у папку яку ви вкажете. Також вона створює `.sh` з інструкціями для завантаження цих даних в `neo4j`.

Недолік `bulk data loading`  у тому, що в процесі він створює нову базу даних. А безплатна версія `neo4j` дозволяє користувачу використовувати лише одну базу даних всередині `neo4j`. Тому якщо ви захочете використовувати `neo4j` для роботи з даними — вам потрібно купити комерційну версію або ж кожного разу видаляти стару базу, що завантажити нову і працювати з нею.



## NetworkX 

Ще однією альтернативою є робота з межевими даними за допомогою бібліотеки NetworkX в Python. Я проілюструю її в Jupyter ноутбуці `processing_graph_from_aleph.ipynb` у цій директорії. Ми використаємо дані створені командою `ftm export-neo4j-bulk`, оскільки NetworkX також може імпортувати дані з `.csv`, а також дозволяє виконувати багато операцій, які робить `neo4j`, без необхідності вивчати мову [Cypher](https://neo4j.com/docs/cypher-refcard/current/), якою будуються команди в neo4j.